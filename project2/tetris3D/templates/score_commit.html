<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>成绩登记</title>
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap-theme.min.css">
    <script type="text/javascript" src="/static/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/d3.min.js"></script>
</head>
<body>
<div class="container-fluid">
    <ul class="nav nav-tabs">
      <li role="presentation"><a href="/SM/query">成绩查询</a></li>
      <li role="presentation" class="active"><a href="/SM/commit">成绩登记</a></li>
      <li role="presentation"><a href="/SM/modification">成绩修改</a></li>
      <li role="presentation"><a href="/SM/logout">退出</a></li>
    </ul>
    <div class="row">
        <div class="col-md-2">
            <h3>尚未提交的课程</h3>
            <ul class="nav nav-pills nav-stacked" id="courseList">
<!--                   <li role="presentation" class="active"><a href="#">英语口语</a></li>
                  <li role="presentation"><a href="#">英语写作</a></li>
                  <li role="presentation"><a href="#">英美文学</a></li> -->
            </ul>
        </div>
        <div class="col-md-8">     

            <table class="table">
                <tr>
                    <th>选课课号</th>
                    <th>课程名称</th>
                    <th>学分</th>
                </tr>
                <tr id="infoTable">
<!--                     <td>(2012-2013-2)-04810020-0096419-1</td>
                    <td>英语口语</td>
                    <td>1.0</td> -->
                </tr>
            </table>

            <a id="downloadButton" href=""><button type="button" class="btn btn-default"><span class="glyphicon glyphicon-download" aria-hidden="true"></span>下载成绩单</button></a>
            <form id="uploadButton" action="" method="post" enctype="multipart/form-data">{% csrf_token %}<button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-upload" aria-hidden="true"></span>上传成绩单 <input id="id_xlsx_file" name="xlsx_file" type="file" /></button></form>
            <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span>正式提交</button>    
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>学号</th>
                    <th>姓名</th>
                    <th>成绩</th>
                    <th>绩点</th>
                </tr>
                </thead>
                <tbody id="studentTable">
<!--                 <tr>
                    <td>3120000001</td>
                    <td>张三</td>
                    <td>87</td>
                    <td>4.20</td>
                </tr>
                <tr>
                    <td>3120000002</td>
                    <td>李四</td>
                    <td>88</td>
                    <td>4.30</td>
                </tr> -->
                </tbody>                
            </table>            
        </div>
    </div>
</div>
<script type="text/javascript">
    //TODO
    d3.json('/SM/B_teacher_query/000001',function(data){
        console.log(data);
        courseInfo = data;
        updateList(data);
    });

var courseInfo;
var theCourseInfo;

function updateList(data){
    d3.select("#courseList").selectAll("li").remove();
    d3.select("#courseList").selectAll("li")
        .data(data)
        .enter().append("li")
        .attr("role","presentation")
        .html(function(d){return '<a href="#" onclick="selectCourse(\'' + d.courseID +'\')">' + d.courseName + "</a>"});
        // .html(function(d){return '<a href="#">' + d.courseName + "</a>"});
    // var firstCourse = d3.select("#courseList").select("li")
    // if(firstCourse.size() >= 1){
    //     firstCourse.attr("class","active");
    // }
}

function selectCourse(courseID){
    // console.log(courseID);
    var course;
    for (var i = courseInfo.length - 1; i >= 0; i--) {
        course = courseInfo[i];
        if(course.courseID == courseID)
            break;
    }
    if(i<0){
        console.log("Cannot find the course");
        return;
    }
    theCourseInfo = course;
    d3.select("#downloadButton").attr("href","/SM/B_download_xlsx/" + course.courseID);
    d3.select("#uploadButton").attr("action","/SM/B_upload_xlsx/" + course.courseID);
    updateInfoTable(course);
    updateStudentTable(course.courseID);
}

function updateStudentTable(courseID){
    // TODO
    d3.json("/SM/B_temp_table_query/"+courseID,function(data){
        // console.log(data);
        d3.select("#studentTable").selectAll("tr").remove();
        d3.select("#studentTable").selectAll("tr")
            .data(data)
            .enter().append("tr")
            .html(function (d) {
            str = '';
            str += "<td>" + d.studentID + "</td>";
            str += "<td>" + d.studentName + "</td>";
            str += "<td>" + d.score + "</td>";
            str += "<td>" + d.gradePoint + "</td>";
            return str;
        });
    })
}

function updateInfoTable(course){
    d3.select("#infoTable").selectAll("td").remove();
    d3.select("#infoTable").selectAll("td")
        .data([course.courseID, course.courseName, course.credits])
        .enter().append("td")
        .text(function(d){return d});
}
</script>
</body>
</html>